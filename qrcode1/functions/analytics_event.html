<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Per-event Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Per-event Analytics</h1>
      <div>
        <select id="countrySelect" class="border p-2 rounded"></select>
        <button id="loadBtn" class="ml-2 bg-amber-600 text-white px-3 py-2 rounded">Load</button>
      </div>
    </header>

    <section class="bg-white p-4 rounded shadow mb-6">
      <h2 class="font-semibold mb-3">Event breakdown (Registered / Invited / Attended)</h2>
      <div class="h-96">
        <canvas id="eventsBar"></canvas>
      </div>
    </section>

    <footer class="text-sm">
      <a href="./analytics_overview.html" class="text-amber-600 hover:underline">‚Üê Back to overview</a>
    </footer>
  </div>

<script>
const BASE_URL = "http://localhost:5001/fuze-be491/us-central1/v1";
const countrySelect = document.getElementById('countrySelect');
const loadBtn = document.getElementById('loadBtn');

let eventsBarChart = null;

async function loadCountries() {
  try {
    const res = await fetch(`${BASE_URL}/events`);
    const countries = await res.json();
    countrySelect.innerHTML = '<option value="">-- Select country --</option>';
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.country;
      opt.textContent = c.country;
      countrySelect.appendChild(opt);
    });
  } catch (err) {
    console.error(err);
    const fallback = 'philippines';
    const opt = document.createElement('option');
    opt.value = fallback;
    opt.textContent = fallback;
    countrySelect.appendChild(opt);
  }
}

async function loadPerEventChart() {
  const country = countrySelect.value;
  if (!country) return alert('Select a country');
  try {
    // fetch events and users
    const [eventsRes, usersRes] = await Promise.all([
      fetch(`${BASE_URL}/events/${country}`),
      fetch(`${BASE_URL}/users/${country}`)
    ]);
    if (!eventsRes.ok) throw new Error('Failed to fetch events: ' + await eventsRes.text());
    if (!usersRes.ok) throw new Error('Failed to fetch users: ' + await usersRes.text());
    const events = await eventsRes.json();
    const users = await usersRes.json();

    // Build map of eventId -> title
    const eventMap = {};
    events.forEach(ev => {
      eventMap[ev.eventId] = ev.title || ev.eventName || ev.eventId;
    });

    // Initialize counts per eventId (use eventId if present, otherwise group by title)
    const counts = {};
    // ensure every event present in counts
    events.forEach(ev => {
      counts[ev.eventId] = { title: eventMap[ev.eventId], registered: 0, invited: 0, attended: 0 };
    });

    // Users may have assignedEvent (title) or assignedEventId
    users.forEach(u => {
      let evId = null;
      if (u.assignedEventId) evId = u.assignedEventId;
      else if (u.assignedEvent) {
        // try to find matching eventId by title
        const match = events.find(e => (e.title || e.eventName) === u.assignedEvent);
        if (match) evId = match.eventId;
      }
      // if still null, skip
      if (!evId) return;

      // ensure event exists in counts (if some events are missing from events collection, create)
      if (!counts[evId]) {
        counts[evId] = { title: eventMap[evId] || u.assignedEvent || evId, registered: 0, invited: 0, attended: 0 };
      }

      counts[evId].registered += 1;
      if (u.invited) counts[evId].invited += 1;
      if (u.attendanceStatus === 'attended' || u.attended === true) counts[evId].attended += 1;
    });

    // prepare chart arrays (sort by date if possible)
    const labels = [];
    const registered = [];
    const invited = [];
    const attended = [];

    // Try to sort events by startTime if available
    const sortedEventIds = Object.keys(counts).sort((a, b) => {
      const evA = events.find(e => e.eventId === a);
      const evB = events.find(e => e.eventId === b);
      if (evA && evB && evA.startTime && evB.startTime) {
        return new Date(evA.startTime) - new Date(evB.startTime);
      }
      return (counts[b].registered - counts[a].registered) * -1; // fallback
    });

    sortedEventIds.forEach(id => {
      labels.push(counts[id].title);
      registered.push(counts[id].registered);
      invited.push(counts[id].invited);
      attended.push(counts[id].attended);
    });

    renderBar(labels, registered, invited, attended);
  } catch (err) {
    console.error(err);
    alert('Failed to load per-event data: ' + err.message);
  }
}

function renderBar(labels, reg, inv, att) {
  const ctx = document.getElementById('eventsBar').getContext('2d');
  if (eventsBarChart) eventsBarChart.destroy();
  eventsBarChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Registered', data: reg, backgroundColor: '#60a5fa' },
        { label: 'Invited', data: inv, backgroundColor: '#f59e0b' },
        { label: 'Attended', data: att, backgroundColor: '#34d399' },
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true }
      }
    }
  });
}

loadCountries();
loadBtn.addEventListener('click', loadPerEventChart);

// auto-select first available country shortly after load
setTimeout(() => {
  if (countrySelect.options.length > 1) {
    countrySelect.selectedIndex = 1;
    // loadPerEventChart();
  }
}, 300);

</script>
</body>
</html>
