<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Event</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; background: #f5f7fa; }
    label { display: block; margin: 10px 0 5px; }
    input, select, button { padding: 8px; width: 100%; max-width: 400px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #message { margin-top: 10px; padding: 8px; border-radius: 6px; display: none; }
    #message.success { background-color: #d4edda; color: #155724; }
    #message.error { background-color: #f8d7da; color: #721c24; }
    table { width: 100%; max-width: 800px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>

<h2>Add New Event</h2>
<a href="../index.html">Back to Home</a>
<div>
  <label for="countrySelect">Select Country:</label>
  <select id="countrySelect"></select>

  <label for="eventTitle">Event Title:</label>
  <input type="text" id="eventTitle" placeholder="Enter event title" />

  <label for="eventTime">Event Start Time:</label>
  <input type="datetime-local" id="eventTime" />

  <button id="addEventBtn">Add Event</button>

  <div id="message"></div>
</div>

<h3>Existing Events</h3>
<table id="eventsTable">
  <thead>
    <tr>
      <th>Event ID</th>
      <th>Title</th>
      <th>Start Time</th>
      <th>Created At</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="4">Select a country to load events</td></tr>
  </tbody>
</table>

<script>
  const BASE_URL = "http://localhost:5001/fuze-be491/us-central1/v1";

  function showMessage(msg, type='success') {
    const div = document.getElementById('message');
    div.innerText = msg;
    div.className = type;
    div.style.display = 'block';
    setTimeout(() => { div.style.display = 'none'; }, 3000);
  }

  function normalizeCountry(country) {
    return country.trim().toLowerCase().replace(/\s+/g, "_");
  }

  async function fetchJSON(url) {
    try {
      const res = await fetch(url);
      const text = await res.text();
      if (text.trim().startsWith('<!DOCTYPE html>')) throw new Error("Server returned HTML instead of JSON");
      return JSON.parse(text);
    } catch(err) {
      console.error(err);
      throw err;
    }
  }

  // Load countries in dropdown
  async function loadCountries() {
    try {
      const countries = await fetchJSON(`${BASE_URL}/events`);
      const select = document.getElementById('countrySelect');
      select.innerHTML = "<option value=''>-- Select Country --</option>";
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.country;
        opt.innerText = c.country;
        select.appendChild(opt);
      });
    } catch(err) {
      showMessage("Error loading countries: " + err.message, "error");
    }
  }

  // Fetch existing events for selected country
  async function loadEvents(country) {
    const tbody = document.querySelector("#eventsTable tbody");
    tbody.innerHTML = "<tr><td colspan='4'>Loading events...</td></tr>";
    if (!country) return;

    try {
      const events = await fetchJSON(`${BASE_URL}/events/${normalizeCountry(country)}/list`);
      if (events.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>No events found</td></tr>";
        return;
      }
      tbody.innerHTML = "";
      events.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.eventId}</td>
          <td>${e.title}</td>
          <td>${new Date(e.startTime).toLocaleString()}</td>
          <td>${new Date(e.createdAt).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch(err) {
      tbody.innerHTML = `<tr><td colspan='4'>Error loading events: ${err.message}</td></tr>`;
    }
  }

  // Add Event Button
  document.getElementById('addEventBtn').addEventListener('click', async () => {
    const country = document.getElementById('countrySelect').value;
    const eventTitle = document.getElementById('eventTitle').value.trim();
    const eventTime = document.getElementById('eventTime').value;

    if (!country || !eventTitle || !eventTime) {
      showMessage("Please fill all fields", "error");
      return;
    }

    try {
      const res = await fetch(`${BASE_URL}/events/${normalizeCountry(country)}/add-event`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ eventTitle, eventTime })
      });
      if (!res.ok) throw new Error(await res.text());
      showMessage(`Event "${eventTitle}" added successfully!`);
      document.getElementById('eventTitle').value = "";
      document.getElementById('eventTime').value = "";
      loadEvents(country); // Refresh event table
    } catch(err) {
      showMessage("Error adding event: " + err.message, "error");
    }
  });

  document.getElementById('countrySelect').addEventListener('change', (e) => {
    const country = e.target.value;
    loadEvents(country);
  });

  window.onload = loadCountries;
</script>

</body>
</html>
