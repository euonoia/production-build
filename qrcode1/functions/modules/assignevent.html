<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assign Event</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f7fa; }
    select, button { padding: 8px; margin: 4px 0; border-radius: 6px; border: 1px solid #ccc; }
    button { cursor: pointer; background-color: #007bff; color: #fff; border: none; }
    button:hover { background-color: #0056b3; }
    #message { margin: 10px 0; padding: 10px; border-radius: 6px; display: none; }
    #message.success { background-color: #d4edda; color: #155724; }
    #message.error { background-color: #f8d7da; color: #721c24; }
    ul { list-style: none; padding: 0; }
    li { padding: 6px 0; }
  </style>
</head>
<body>

  <h2>Assign Event to Users</h2>
    <a href="../index.html">return</a>
  <div>
    <label for="countrySelect"><b>Select Country:</b></label>
    <select id="countrySelect"></select>
  </div>

  <div>
    <label for="eventSelect"><b>Select Event:</b></label>
    <select id="eventSelect"></select>
  </div>

  <div>
    <h3>Select Users:</h3>
    <input type="checkbox" id="selectAllUsers"> <label for="selectAllUsers">Select All Users</label>
    <ul id="usersList"></ul>
  </div>

  <button id="assignBtn">Assign Event</button>

  <div id="message"></div>

  <script>
    const BASE_URL = "http://localhost:5001/fuze-be491/us-central1/v1";
    let usersData = [];
    let COUNTRY = "";

    function showMessage(msg, type='success') {
      const div = document.getElementById('message');
      div.innerText = msg;
      div.className = type;
      div.style.display = 'block';
      setTimeout(() => { div.style.display = 'none'; }, 4000);
    }

    function normalizeCountry(country) {
      return country.trim().toLowerCase().replace(/\s+/g, "_");
    }

    // Load countries
    async function loadCountries() {
      try {
        const res = await fetch(`${BASE_URL}/events`);
        if (!res.ok) throw new Error(await res.text());
        const countries = await res.json();
        const countrySelect = document.getElementById('countrySelect');
        countrySelect.innerHTML = "";

        countries.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.country;
          opt.innerText = c.country;
          countrySelect.appendChild(opt);
        });

        if (countries.length > 0) {
          COUNTRY = countries[0].country;
          countrySelect.value = COUNTRY;
          await loadEvents();
          await loadUsers();
        }

        countrySelect.onchange = async () => {
          COUNTRY = countrySelect.value;
          await loadEvents();
          await loadUsers();
        };

      } catch (err) {
        showMessage("Error loading countries: " + err.message, "error");
      }
    }

    // Load events for selected country
    async function loadEvents() {
      try {
        const normalized = normalizeCountry(COUNTRY);
        const res = await fetch(`${BASE_URL}/events/${normalized}/list`);
        if (!res.ok) throw new Error(await res.text());
        const events = await res.json();

        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = "";
        events.forEach(ev => {
          const opt = document.createElement('option');
          opt.value = ev.eventName;
          opt.innerText = `${ev.eventName} (${new Date(ev.eventTime).toLocaleString()})`;
          eventSelect.appendChild(opt);
        });
      } catch (err) {
        showMessage("Error loading events: " + err.message, "error");
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const normalized = normalizeCountry(COUNTRY);
        const res = await fetch(`${BASE_URL}/events/${normalized}/users`);
        if (!res.ok) throw new Error(await res.text());
        usersData = await res.json();

        const usersList = document.getElementById('usersList');
        usersList.innerHTML = "";

        usersData.forEach(u => {
          const li = document.createElement('li');
          li.innerHTML = `<input type="checkbox" class="userCheckbox" value="${u.userId}" id="user_${u.userId}">
                          <label for="user_${u.userId}">${u.firstName} ${u.lastName} (${u.email})</label>`;
          usersList.appendChild(li);
        });

        document.getElementById('selectAllUsers').onclick = function() {
          const checked = this.checked;
          document.querySelectorAll('.userCheckbox').forEach(cb => cb.checked = checked);
        };

      } catch (err) {
        showMessage("Error loading users: " + err.message, "error");
      }
    }

    // Assign event to selected users
    async function assignEvent() {
      try {
        const eventSelect = document.getElementById('eventSelect');
        const selectedEvent = eventSelect.value;

        const selectedUserIds = Array.from(document.querySelectorAll('.userCheckbox'))
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        const normalized = normalizeCountry(COUNTRY);

        const body = { eventTitle: selectedEvent, userIds: selectedUserIds };

        const res = await fetch(`${BASE_URL}/events/${normalized}/assign-event`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(await res.text());
        showMessage(`Event "${selectedEvent}" assigned successfully!`, "success");

      } catch (err) {
        showMessage("Error assigning event: " + err.message, "error");
      }
    }

    document.getElementById('assignBtn').onclick = assignEvent;

    window.onload = loadCountries;
  </script>
</body>
</html>
